{% extends "base.html" %}
{% load static %}
{% block content %}
<h3 class="mb-3">Dashboard</h3>
<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card text-bg-light">
      <div class="card-body">
        <div class="fw-bold">Total Patients</div>
        <div class="fs-3">{{ total_patients }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-light">
      <div class="card-body">
        <div class="fw-bold">Risk Breakdown</div>
        <ul class="mb-0">
          {% for item in risk_breakdown %}
            <li>{{ item.risk_category }}: {{ item.count }}</li>
          {% empty %}
            <li>No predictions yet</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-light">
      <div class="card-body">
        <div class="fw-bold">Outcomes</div>
        <ul class="mb-0">
          {% for item in outcomes %}
            <li>{{ item.outcome|default:"(none)" }}: {{ item.count }}</li>
          {% empty %}
            <li>No outcomes yet</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header">Recent Predictions</div>
  <div class="card-body p-0">
    <table class="table mb-0 table-sm">
      <thead><tr><th>ID</th><th>Patient</th><th>Score</th><th>Category</th><th>Timestamp</th></tr></thead>
      <tbody>
      {% for p in recent_predictions %}
        <tr>
          <td>{{ p.prediction_id }}</td>
          <td>{{ p.patient.patient_id }}</td>
          <td>{{ p.risk_score }}</td>
          <td>{{ p.risk_category }}</td>
          <td>{{ p.timestamp }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="text-center">No predictions yet</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="row g-3 mt-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Risk Breakdown</div>
      <div class="card-body">
        <canvas id="riskChart" height="200"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">Outcomes</div>
      <div class="card-body">
        <canvas id="outcomeChart" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

{% include "partials/charts.html" %}
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const riskLabels = [{% for item in risk_breakdown %}"{{ item.risk_category|default:"unknown" }}",{% endfor %}];
    const riskData = [{% for item in risk_breakdown %}{{ item.count }},{% endfor %}];
    renderDoughnut("riskChart", riskLabels, riskData, "Risk Categories");

    const outcomeLabels = [{% for item in outcomes %}"{{ item.outcome|default:"unknown" }}",{% endfor %}];
    const outcomeData = [{% for item in outcomes %}{{ item.count }},{% endfor %}];
    renderDoughnut("outcomeChart", outcomeLabels, outcomeData, "Treatment Outcomes");
  });
</script>
{% endblock %}

