{% extends "base.html" %}
{% load static %}

{% block title %}Researcher Dashboard | PTLD System{% endblock %}

{% block breadcrumbs %}
<a href="{% url 'researchers:dashboard' %}">Home</a>
&rsaquo; Researcher Dashboard
{% endblock %}

{% block content %}
<h1>Researcher Dashboard - Analytics & Insights</h1>

<div id="content-main">
    <!-- Summary Statistics -->
    <div class="module stats-module">
        <table>
            <caption>
                <a href="#" class="section">Dataset Overview</a>
            </caption>
            <tr>
                <th scope="row">Total Patients</th>
                <td><strong>{{ total_patients }}</strong></td>
            </tr>
            <tr>
                <th scope="row">Total Predictions</th>
                <td><strong>{{ total_predictions }}</strong></td>
            </tr>
        </table>
    </div>

    <!-- Two Column Layout for Charts -->
    <div class="charts-grid">
        <!-- Risk Trend Analysis -->
        <div class="module chart-module">
            <h3>Risk Trend Analysis</h3>
            <p class="help">Average risk by treatment month (1-4)</p>
            <div class="chart-container">
                <canvas id="riskTrendChart"></canvas>
            </div>
            <div id="riskTrendData" class="chart-data"></div>
        </div>

        <!-- Risk Distribution -->
        <div class="module chart-module">
            <h3>Risk Distribution</h3>
            <p class="help">Patients by risk category</p>
            <div class="chart-container small-chart">
                <canvas id="riskDistributionChart"></canvas>
            </div>
            <div id="riskDistributionData" class="chart-data"></div>
        </div>
    </div>

    <!-- Group-Based Risk Comparison -->
    <div class="module chart-module">
        <h3>Group-Based Risk Comparison</h3>
        <p class="help">Average risk score by demographic and clinical factors</p>
        <div style="margin-bottom: 10px;">
            <label for="groupType" style="margin-right: 10px;">Group by:</label>
            <select id="groupType" onchange="loadGroupComparison()" style="padding: 5px;">
                <option value="age">Age Group</option>
                <option value="sex">Sex</option>
                <option value="smoking">Smoking Status</option>
                <option value="hiv">HIV Status</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="groupComparisonChart"></canvas>
        </div>
        <div id="groupComparisonData" class="chart-data"></div>
    </div>

    <!-- Population-Level SHAP Analysis -->
    <div class="module chart-module">
        <h3>Population-Level Feature Importance</h3>
        <p class="help">Global feature importance (mean absolute SHAP values)</p>
        <div class="chart-container">
            <canvas id="shapChart"></canvas>
        </div>
        <div id="shapData" class="chart-data"></div>
    </div>

    <!-- Outcome Association -->
    <div class="module chart-module">
        <h3>Outcome Association Analysis</h3>
        <p class="help">Predicted risk category vs treatment outcome</p>
        <div id="outcomeAssociationData" class="outcome-table"></div>
        <div class="chart-container">
            <canvas id="outcomeChart"></canvas>
        </div>
    </div>

    <!-- Data Export -->
    <div class="module export-module">
        <h3>Data Export</h3>
        <p class="help">Download anonymized, aggregated dataset (CSV format)</p>
        <p style="font-size: 12px; color: #666;"><strong>Note:</strong> All patient identifiers are removed. Only aggregated statistics are included.</p>
        <a href="{% url 'researchers:export-data' %}" class="button default">Download Anonymized Data (CSV)</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Chart configuration - smaller, more compact
const chartOptions = {
    responsive: true,
    maintainAspectRatio: true,
    plugins: {
        legend: {
            display: true,
            position: 'bottom',
            labels: {
                boxWidth: 12,
                padding: 8,
                font: { size: 11 }
            }
        }
    }
};

// Risk Trend Chart
function loadRiskTrend() {
    fetch('{% url "researchers:risk-trend" %}', {
        credentials: 'include',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const ctx = document.getElementById('riskTrendChart').getContext('2d');
            const chartData = {
                labels: data.data.map(d => `Month ${d.month}`),
                datasets: [{
                    label: 'Average Risk Score',
                    data: data.data.map(d => d.average_risk),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1,
                    borderWidth: 2
                }]
            };
            new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    ...chartOptions,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 1.0,
                            ticks: { font: { size: 10 } }
                        },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });
            const totalSamples = data.data.reduce((sum, d) => sum + d.sample_size, 0);
            document.getElementById('riskTrendData').innerHTML = 
                `<small style="color: #666;">Total samples: ${totalSamples}</small>`;
        })
        .catch(error => {
            console.error('Error loading risk trend:', error);
            document.getElementById('riskTrendData').innerHTML = 
                `<small style="color: #d32f2f;">Error loading data: ${error.message}</small>`;
        });
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Risk Distribution Chart
function loadRiskDistribution() {
    fetch('{% url "researchers:risk-distribution" %}', {
        credentials: 'include',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const ctx = document.getElementById('riskDistributionChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.data.map(d => d.category),
                    datasets: [{
                        data: data.data.map(d => d.count),
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',   // Green for low
                            'rgba(255, 193, 7, 0.8)',   // Yellow for medium
                            'rgba(220, 53, 69, 0.8)'    // Red for high
                        ]
                    }]
                },
                options: {
                    ...chartOptions,
                    plugins: {
                        ...chartOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            let html = '<table class="data-table"><tr><th>Category</th><th>Count</th><th>%</th></tr>';
            data.data.forEach(item => {
                const pct = ((item.count / data.total) * 100).toFixed(1);
                html += `<tr><td>${item.category}</td><td>${item.count}</td><td>${pct}%</td></tr>`;
            });
            html += '</table>';
            document.getElementById('riskDistributionData').innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading risk distribution:', error);
            document.getElementById('riskDistributionData').innerHTML = 
                `<small style="color: #d32f2f;">Error loading data: ${error.message}</small>`;
        });
}

// Group Comparison Chart
function loadGroupComparison() {
    const groupType = document.getElementById('groupType').value;
    fetch(`{% url "researchers:group-comparison" %}?group=${groupType}`, {
        credentials: 'include',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const ctx = document.getElementById('groupComparisonChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.data.map(d => d.group),
                    datasets: [{
                        label: 'Average Risk Score',
                        data: data.data.map(d => d.average_risk),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)'
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 1.0,
                            ticks: { font: { size: 10 } }
                        },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });
            let html = '<table class="data-table"><tr><th>Group</th><th>Avg Risk</th><th>Count</th></tr>';
            data.data.forEach(item => {
                html += `<tr><td>${item.group}</td><td>${item.average_risk}</td><td>${item.count}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('groupComparisonData').innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading group comparison:', error);
            document.getElementById('groupComparisonData').innerHTML = 
                `<small style="color: #d32f2f;">Error loading data: ${error.message}</small>`;
        });
}

// SHAP Analysis Chart
function loadSHAPAnalysis() {
    fetch('{% url "researchers:shap-analysis" %}', {
        credentials: 'include',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.data.length === 0) {
                document.getElementById('shapData').innerHTML = '<p class="help">No SHAP data available.</p>';
                return;
            }
            const ctx = document.getElementById('shapChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.data.map(d => d.feature),
                    datasets: [{
                        label: 'Mean Absolute SHAP',
                        data: data.data.map(d => d.mean_absolute_shap),
                        backgroundColor: 'rgba(153, 102, 255, 0.8)'
                    }]
                },
                options: {
                    ...chartOptions,
                    indexAxis: 'y',
                    scales: {
                        x: { 
                            beginAtZero: true,
                            ticks: { font: { size: 10 } }
                        },
                        y: { ticks: { font: { size: 10 } } }
                    }
                }
            });
            let html = '<table class="data-table"><tr><th>Feature</th><th>Importance</th><th>N</th></tr>';
            data.data.forEach(item => {
                html += `<tr><td>${item.feature}</td><td>${item.mean_absolute_shap}</td><td>${item.sample_size}</td></tr>`;
            });
            html += '</table>';
            document.getElementById('shapData').innerHTML = html;
        })
        .catch(error => {
            console.error('Error loading SHAP analysis:', error);
            document.getElementById('shapData').innerHTML = 
                `<small style="color: #d32f2f;">Error loading data: ${error.message}</small>`;
        });
}

// Outcome Association
function loadOutcomeAssociation() {
    fetch('{% url "researchers:outcome-association" %}', {
        credentials: 'include',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            // Display compact cross-tabulation table
            let html = '<div style="margin-bottom: 15px;"><h4 style="margin: 0 0 10px 0; font-size: 14px;">Cross-Tabulation</h4>';
            html += '<table class="data-table compact-table">';
            html += '<tr><th>Risk</th><th>Cured</th><th>Completed</th><th>Failed</th><th>Died</th><th>Lost</th><th>Transferred</th><th>Total</th></tr>';
            data.cross_tabulation.forEach(row => {
                html += `<tr><td><strong>${row.risk_category}</strong></td>`;
                html += `<td>${row.cured || 0}</td>`;
                html += `<td>${row.completed || 0}</td>`;
                html += `<td>${row.failed || 0}</td>`;
                html += `<td>${row.died || 0}</td>`;
                html += `<td>${row.lost || 0}</td>`;
                html += `<td>${row.transferred || 0}</td>`;
                html += `<td><strong>${row.total}</strong></td></tr>`;
            });
            html += '</table></div>';
            
            html += '<div><h4 style="margin: 0 0 10px 0; font-size: 14px;">Success Rate Summary</h4>';
            html += '<table class="data-table">';
            html += '<tr><th>Risk Category</th><th>Total</th><th>Success</th><th>Success Rate</th></tr>';
            data.summary.forEach(item => {
                html += `<tr><td>${item.risk_category}</td><td>${item.total_patients}</td><td>${item.success_count}</td><td><strong>${item.success_rate}%</strong></td></tr>`;
            });
            html += '</table></div>';
            
            document.getElementById('outcomeAssociationData').innerHTML = html;
            
            // Chart
            const ctx = document.getElementById('outcomeChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.summary.map(d => d.risk_category),
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: data.summary.map(d => d.success_rate),
                        backgroundColor: 'rgba(40, 167, 69, 0.8)'
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: { font: { size: 10 } }
                        },
                        x: { ticks: { font: { size: 10 } } }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading outcome association:', error);
            document.getElementById('outcomeAssociationData').innerHTML = 
                `<small style="color: #d32f2f;">Error loading data: ${error.message}</small>`;
        });
}

// Load all charts on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRiskTrend();
    loadRiskDistribution();
    loadGroupComparison();
    loadSHAPAnalysis();
    loadOutcomeAssociation();
});
</script>

<style>
.module {
    margin-bottom: 20px;
    padding: 15px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.module h2, .module h3 {
    margin-top: 0;
    margin-bottom: 8px;
    color: #417690;
    font-size: 16px;
}
.module h3 {
    font-size: 15px;
}
.module .help {
    font-size: 12px;
    color: #666;
    margin-bottom: 10px;
    margin-top: 0;
}

/* Grid layout for charts */
.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .charts-grid {
        grid-template-columns: 1fr;
    }
}

/* Chart containers - smaller, more compact */
.chart-container {
    position: relative;
    height: 250px;
    margin: 10px 0;
}
.chart-container.small-chart {
    height: 200px;
}

/* Stats module - compact */
.stats-module {
    margin-bottom: 15px;
}

/* Chart modules */
.chart-module {
    min-height: auto;
}

/* Data tables - compact */
.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: 12px;
}
.data-table th, .data-table td {
    padding: 6px 8px;
    text-align: left;
    border-bottom: 1px solid #e0e0e0;
}
.data-table th {
    background-color: #f5f5f5;
    font-weight: 600;
    font-size: 11px;
    text-transform: uppercase;
    color: #666;
}
.data-table tr:hover {
    background-color: #f9f9f9;
}

.compact-table {
    font-size: 11px;
}
.compact-table th, .compact-table td {
    padding: 4px 6px;
}

.chart-data {
    margin-top: 10px;
    font-size: 12px;
    color: #666;
}

.outcome-table {
    margin-bottom: 15px;
}

.export-module {
    text-align: center;
    padding: 20px;
}
.export-module .button {
    margin-top: 10px;
}
</style>
{% endblock %}

