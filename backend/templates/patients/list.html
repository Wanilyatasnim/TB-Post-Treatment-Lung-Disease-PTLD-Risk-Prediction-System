{% extends "base.html" %}
{% load static %}

{% block title %}Select Patient to change | PTLD System{% endblock %}

{% block breadcrumbs %}
<a href="{% url 'patients:patient-list' %}">Home</a>
&rsaquo; Patients
{% endblock %}

{% block content %}
<div id="changelist" class="module filtered">
    <div id="changelist-filter">
        <h2>Filter</h2>
        <h3>By Sex</h3>
        <ul class="filter-list">
            <li{% if request.GET.sex == 'M' %} class="selected"{% endif %}>
                <a href="?sex=M{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">Male</a>
            </li>
            <li{% if request.GET.sex == 'F' %} class="selected"{% endif %}>
                <a href="?sex=F{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">Female</a>
            </li>
        </ul>
        <h3>By HIV Status</h3>
        <ul class="filter-list">
            <li{% if request.GET.hiv == '1' %} class="selected"{% endif %}>
                <a href="?hiv=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">Yes</a>
            </li>
            <li{% if request.GET.hiv == '0' %} class="selected"{% endif %}>
                <a href="?hiv=0{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">No</a>
            </li>
        </ul>
        <h3>By Diabetes</h3>
        <ul class="filter-list">
            <li{% if request.GET.diabetes == '1' %} class="selected"{% endif %}>
                <a href="?diabetes=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}">Yes</a>
            </li>
            <li{% if request.GET.diabetes == '0' %} class="selected"{% endif %}>
                <a href="?diabetes=0{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}">No</a>
            </li>
        </ul>
    </div>
    
    <div id="changelist-form">
        <form id="changelist-search" method="get">
            <div>
                <label for="searchbar"><img src="{% static 'admin/img/search.svg' %}" alt="Search"></label>
                <input type="text" size="40" name="search" value="{{ request.GET.search }}" id="searchbar" autofocus placeholder="Search by Patient ID or District...">
                <input type="submit" value="Search">
                {% if request.GET.search or request.GET.sex or request.GET.hiv or request.GET.diabetes %}
                <a href="{% url 'patients:patient-list' %}" class="small quiet" style="margin-left: 10px;">Clear all filters</a>
                {% endif %}
            </div>
        </form>
        
        <form id="changelist-form" method="post" novalidate>
            {% csrf_token %}
            <div class="results">
                <table id="result_list">
                    <thead>
                        <tr>
                            <th scope="col" class="sortable column-patient_id">
                                <div class="text"><a href="?o=1">ID</a></div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-race_color">
                                <div class="text">Race/Color</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-age_group">
                                <div class="text">Age Group</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-sex">
                                <div class="text"><a href="?o=2">Sex</a></div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-pregnant">
                                <div class="text">Pregnant</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-education">
                                <div class="text">Education</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-occupation">
                                <div class="text">Occupation</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-previous_treatment">
                                <div class="text">Previous Treatment</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-treated_before">
                                <div class="text">Treated Before</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-current_situation">
                                <div class="text">Current Situation</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-case_type">
                                <div class="text">Case Type</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-clinical_form">
                                <div class="text">Clinical Form</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-classification">
                                <div class="text">Classification</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-discovery">
                                <div class="text">Discovery</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-bacilloscopy">
                                <div class="text">Bacilloscopy</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-sputum_culture">
                                <div class="text">Sputum Culture</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-x_ray">
                                <div class="text">X-Ray</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-necropsy">
                                <div class="text">Necropsy</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-hiv">
                                <div class="text">HIV</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-aids">
                                <div class="text">AIDS</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-diabetes">
                                <div class="text">Diabetes</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-alcoholism">
                                <div class="text">Alcoholism</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-mental_disorder">
                                <div class="text">Mental Disorder</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-drug_addiction">
                                <div class="text">Drug Addiction</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-smoking">
                                <div class="text">Smoking</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-total_contacts">
                                <div class="text">Total Contacts</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-contacts_examined">
                                <div class="text">Contacts Examined</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-sick_contacts">
                                <div class="text">Sick Contacts</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-treatment_institution">
                                <div class="text">Treatment Institution</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-initial_regimen">
                                <div class="text">Initial Regimen</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-regimen_change">
                                <div class="text">Regimen Change</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-current_regimen">
                                <div class="text">Current Regimen</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-reason_change">
                                <div class="text">Reason Change</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-treatment_type">
                                <div class="text">Treatment Type</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-primary_doses">
                                <div class="text">Primary Doses</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-secondary_doses">
                                <div class="text">Secondary Doses</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-age">
                                <div class="text"><a href="?o=3">Age</a></div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-resistance">
                                <div class="text">Resistance</div>
                                <div class="clear"></div>
                            </th>
                            <th scope="col" class="sortable column-hospitalization">
                                <div class="text">Hospitalization Reason</div>
                                <div class="clear"></div>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for patient in patients %}
                        <tr class="{% cycle 'row1' 'row2' %}">
                            <th class="field-patient_id">
                                <a href="{% url 'patients:patient-detail' patient.patient_id %}">{{ patient.patient_id }}</a>
                            </th>
                            <td class="field-race_color"><span class="quiet">-</span></td>
                            <td class="field-age_group">
                                {% if patient.age < 20 %}0-19
                                {% elif patient.age < 30 %}20-29
                                {% elif patient.age < 40 %}30-39
                                {% elif patient.age < 50 %}40-49
                                {% elif patient.age < 60 %}50-59
                                {% else %}60+{% endif %}
                            </td>
                            <td class="field-sex">{{ patient.sex }}</td>
                            <td class="field-pregnant">
                                {% if patient.sex == 'F' %}<span class="quiet">-</span>{% else %}<span class="quiet">N/A</span>{% endif %}
                            </td>
                            <td class="field-education"><span class="quiet">-</span></td>
                            <td class="field-occupation"><span class="quiet">-</span></td>
                            <td class="field-previous_treatment"><span class="quiet">-</span></td>
                            <td class="field-treated_before">
                                {% if patient.regimens.exists %}<img src="{% static 'admin/img/icon-yes.svg' %}" alt="Yes">{% else %}<img src="{% static 'admin/img/icon-no.svg' %}" alt="No">{% endif %}
                            </td>
                            <td class="field-current_situation">
                                {% if patient.regimens.exists %}
                                    {% with latest=patient.regimens.first %}
                                        {{ latest.outcome|default:"-" }}
                                    {% endwith %}
                                {% else %}
                                    <span class="quiet">-</span>
                                {% endif %}
                            </td>
                            <td class="field-case_type"><span class="quiet">-</span></td>
                            <td class="field-clinical_form"><span class="quiet">-</span></td>
                            <td class="field-classification"><span class="quiet">-</span></td>
                            <td class="field-discovery"><span class="quiet">-</span></td>
                            <td class="field-bacilloscopy">
                                {% if patient.visits.exists %}
                                    {% with latest=patient.visits.first %}
                                        {{ latest.smear_result|default:"-" }}
                                    {% endwith %}
                                {% else %}
                                    <span class="quiet">-</span>
                                {% endif %}
                            </td>
                            <td class="field-sputum_culture"><span class="quiet">-</span></td>
                            <td class="field-x_ray">
                                {% if patient.x_ray_score %}
                                    {% if patient.x_ray_score >= 10 %}Suspected TB
                                    {% elif patient.x_ray_score >= 5 %}Suspected with Cavity
                                    {% else %}Not Performed{% endif %}
                                {% else %}
                                    <span class="quiet">-</span>
                                {% endif %}
                            </td>
                            <td class="field-necropsy"><span class="quiet">-</span></td>
                            <td class="field-hiv">
                                {% if patient.hiv_positive %}
                                    <img src="{% static 'admin/img/icon-yes.svg' %}" alt="Yes" title="HIV Positive">
                                {% else %}
                                    <img src="{% static 'admin/img/icon-no.svg' %}" alt="No" title="HIV Negative">
                                {% endif %}
                            </td>
                            <td class="field-aids"><span class="quiet">-</span></td>
                            <td class="field-diabetes">
                                {% if patient.diabetes %}
                                    <img src="{% static 'admin/img/icon-yes.svg' %}" alt="Yes" title="Has Diabetes">
                                {% else %}
                                    <img src="{% static 'admin/img/icon-no.svg' %}" alt="No" title="No Diabetes">
                                {% endif %}
                            </td>
                            <td class="field-alcoholism"><span class="quiet">-</span></td>
                            <td class="field-mental_disorder"><span class="quiet">-</span></td>
                            <td class="field-drug_addiction"><span class="quiet">-</span></td>
                            <td class="field-smoking">
                                {% if patient.smoker %}
                                    <img src="{% static 'admin/img/icon-yes.svg' %}" alt="Yes" title="Smoker">
                                {% else %}
                                    <img src="{% static 'admin/img/icon-no.svg' %}" alt="No" title="Non-smoker">
                                {% endif %}
                            </td>
                            <td class="field-total_contacts"><span class="quiet">0</span></td>
                            <td class="field-contacts_examined"><span class="quiet">0</span></td>
                            <td class="field-sick_contacts"><span class="quiet">0</span></td>
                            <td class="field-treatment_institution"><span class="quiet">-</span></td>
                            <td class="field-initial_regimen">
                                {% if patient.regimens.exists %}
                                    {{ patient.regimens.first.drugs|default:"-" }}
                                {% else %}
                                    <span class="quiet">-</span>
                                {% endif %}
                            </td>
                            <td class="field-regimen_change">
                                {% if patient.modifications.exists %}
                                    <img src="{% static 'admin/img/icon-yes.svg' %}" alt="Yes">
                                {% else %}
                                    <img src="{% static 'admin/img/icon-no.svg' %}" alt="No">
                                {% endif %}
                            </td>
                            <td class="field-current_regimen">
                                {% if patient.regimens.exists %}
                                    {{ patient.regimens.first.drugs|default:"-" }}
                                {% else %}
                                    <span class="quiet">-</span>
                                {% endif %}
                            </td>
                            <td class="field-reason_change">
                                {% if patient.modifications.exists %}
                                    {{ patient.modifications.first.reason|default:"-" }}
                                {% else %}
                                    <span class="quiet">-</span>
                                {% endif %}
                            </td>
                            <td class="field-treatment_type"><span class="quiet">-</span></td>
                            <td class="field-primary_doses"><span class="quiet">0</span></td>
                            <td class="field-secondary_doses"><span class="quiet">0</span></td>
                            <td class="field-age">{{ patient.age }}</td>
                            <td class="field-resistance"><span class="quiet">-</span></td>
                            <td class="field-hospitalization"><span class="quiet">-</span></td>
                        </tr>
                        {% empty %}
                        <tr class="row1">
                            <td colspan="42" class="text-center">
                                <p class="errornote">No patients found.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <p class="paginator">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">&laquo; first</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">previous</a>
                {% endif %}
                
                <span class="this-page">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}{% if request.GET.hiv %}&hiv={{ request.GET.hiv }}{% endif %}{% if request.GET.diabetes %}&diabetes={{ request.GET.diabetes }}{% endif %}">last &raquo;</a>
                {% endif %}
                
                {{ page_obj.paginator.count }} patient{{ page_obj.paginator.count|pluralize }}
            </p>
        </form>
    </div>
</div>

<ul class="object-tools">
    <li>
        <a href="{% url 'patients:patient-create' %}" class="addlink">
            Add patient
        </a>
    </li>
</ul>

<style>
/* Django Admin Changelist Styles */
#changelist {
    position: relative;
    background: #fff;
    border: 1px solid #ddd;
    margin-left: 0;
}

#changelist-filter {
    position: absolute;
    right: 0;
    top: 0;
    width: 200px;
    background: #f8f9fa;
    border-left: 1px solid #ddd;
    padding: 10px;
    font-size: 12px;
    min-height: 100%;
}

#changelist-filter h2 {
    font-size: 13px;
    font-weight: 600;
    margin: 0 0 10px 0;
    padding: 0;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#changelist-filter h3 {
    font-size: 12px;
    font-weight: 600;
    margin: 15px 0 5px 0;
    padding: 0;
    color: #333;
}

#changelist-filter .filter-list {
    list-style: none;
    padding: 0;
    margin: 0 0 15px 0;
}

#changelist-filter .filter-list li {
    padding: 3px 0;
}

#changelist-filter .filter-list li.selected {
    background: #417690;
    margin: 0 -10px;
    padding: 3px 10px;
}

#changelist-filter .filter-list li.selected a {
    color: #fff;
    font-weight: 600;
}

#changelist-filter .filter-list a {
    color: #417690;
    text-decoration: none;
    display: block;
    padding: 2px 0;
}

#changelist-filter .filter-list a:hover {
    text-decoration: underline;
}

#changelist-form {
    margin-right: 220px;
    position: relative;
}

#changelist-search {
    padding: 10px;
    background: #fff;
    border-bottom: 1px solid #ddd;
}

#changelist-search > div {
    display: flex;
    align-items: center;
    gap: 10px;
}

#changelist-search label {
    display: inline-block;
}

#changelist-search label img {
    vertical-align: middle;
}

#changelist-search input[type="text"] {
    width: 300px;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

#changelist-search input[type="submit"] {
    padding: 6px 15px;
    background: #417690;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}

#changelist-search input[type="submit"]:hover {
    background: #205067;
}

#changelist-search .quiet {
    color: #ba2121;
    text-decoration: none;
    font-size: 11px;
}

#changelist-search .quiet:hover {
    text-decoration: underline;
}

.results {
    overflow-x: auto;
}

#result_list {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
}

#result_list thead th {
    background: #f5f5f5;
    padding: 6px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid #ddd;
    white-space: nowrap;
    font-size: 11px;
}

#result_list thead th.sortable {
    background: #f5f5f5 url({% static 'admin/img/sorting-icons.svg' %}) no-repeat right 8px center;
    padding-right: 25px;
}

#result_list thead th.sortable .text a {
    color: #417690;
    text-decoration: none;
}

#result_list thead th.sortable .text a:hover {
    color: #205067;
}

#result_list tbody tr.row1 {
    background: #fff;
}

#result_list tbody tr.row2 {
    background: #f9f9f9;
}

#result_list tbody tr:hover {
    background: #f0f0f0;
}

#result_list tbody th,
#result_list tbody td {
    padding: 6px 8px;
    border-bottom: 1px solid #eee;
    font-size: 11px;
    white-space: nowrap;
}

#result_list tbody th {
    font-weight: 600;
}

#result_list tbody th a {
    color: #417690;
    text-decoration: none;
}

#result_list tbody th a:hover {
    text-decoration: underline;
}

#result_list tbody td img {
    vertical-align: middle;
}

.quiet {
    color: #999;
    font-style: italic;
}

.paginator {
    padding: 10px;
    background: #fff;
    border-top: 1px solid #ddd;
    text-align: center;
    font-size: 13px;
    color: #666;
}

.paginator a {
    color: #417690;
    text-decoration: none;
    margin: 0 5px;
}

.paginator a:hover {
    text-decoration: underline;
}

.paginator .this-page {
    margin: 0 10px;
    font-weight: 600;
}

.object-tools {
    list-style: none;
    padding: 0;
    margin: 0 0 20px 0;
    float: right;
}

.object-tools li {
    float: left;
    margin-left: 5px;
}

.object-tools .addlink {
    background: #417690 url({% static 'admin/img/icon-addlink.svg' %}) 0 1px no-repeat;
    padding: 10px 12px 10px 26px;
    color: #fff;
    text-decoration: none;
    border-radius: 4px;
    font-size: 13px;
    font-weight: 400;
}

.object-tools .addlink:hover {
    background-color: #205067;
}

.errornote {
    padding: 10px;
    color: #ba2121;
    background: #fff;
    border: 1px solid #ba2121;
    border-radius: 4px;
    margin: 10px 0;
}

.clear {
    clear: both;
}
</style>
{% endblock %}
