{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h3 class="mb-0">Patients</h3>
  <a class="btn btn-primary" href="{% url 'patients:patient-create' %}">
    <i class="bi bi-plus-circle"></i> Add Patient
  </a>
</div>

<!-- Search and Filter -->
<div class="card mb-3">
  <div class="card-body">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <label for="search" class="form-label">Search</label>
        <input type="text" class="form-control" id="search" name="search" 
               placeholder="Patient ID, District..." value="{{ request.GET.search }}">
      </div>
      <div class="col-md-2">
        <label for="sex" class="form-label">Sex</label>
        <select class="form-select" id="sex" name="sex">
          <option value="">All</option>
          <option value="M" {% if request.GET.sex == 'M' %}selected{% endif %}>Male</option>
          <option value="F" {% if request.GET.sex == 'F' %}selected{% endif %}>Female</option>
        </select>
      </div>
      <div class="col-md-2">
        <label for="hiv" class="form-label">HIV</label>
        <select class="form-select" id="hiv" name="hiv">
          <option value="">All</option>
          <option value="1" {% if request.GET.hiv == '1' %}selected{% endif %}>Yes</option>
          <option value="0" {% if request.GET.hiv == '0' %}selected{% endif %}>No</option>
        </select>
      </div>
      <div class="col-md-2">
        <label for="diabetes" class="form-label">Diabetes</label>
        <select class="form-select" id="diabetes" name="diabetes">
          <option value="">All</option>
          <option value="1" {% if request.GET.diabetes == '1' %}selected{% endif %}>Yes</option>
          <option value="0" {% if request.GET.diabetes == '0' %}selected{% endif %}>No</option>
        </select>
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
    </form>
  </div>
</div>

<!-- Patient Count -->
<div class="alert alert-info">
  <strong>{{ page_obj.paginator.count }}</strong> patient{{ page_obj.paginator.count|pluralize }} found
</div>

<!-- Patient Table -->
<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Sex</th>
            <th>Age</th>
            <th>BMI</th>
            <th>HIV</th>
            <th>Diabetes</th>
            <th>Smoker</th>
            <th>X-ray Score</th>
            <th>District</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for patient in patients %}
          <tr>
            <td><strong>{{ patient.patient_id }}</strong></td>
            <td>{{ patient.sex }}</td>
            <td>{{ patient.age }}</td>
            <td>{% if patient.bmi %}{{ patient.bmi|floatformat:1 }}{% else %}-{% endif %}</td>
            <td>
              {% if patient.hiv_positive %}
                <span class="badge bg-danger">Yes</span>
              {% else %}
                <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>
            <td>
              {% if patient.diabetes %}
                <span class="badge bg-warning text-dark">Yes</span>
              {% else %}
                <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>
            <td>
              {% if patient.smoker %}
                <span class="badge bg-warning text-dark">Yes</span>
              {% else %}
                <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>
            <td>{% if patient.x_ray_score %}{{ patient.x_ray_score|floatformat:1 }}{% else %}-{% endif %}</td>
            <td>{{ patient.district|default:"-" }}</td>
            <td>
              <a href="{% url 'patients:patient-detail' patient.patient_id %}" 
                 class="btn btn-sm btn-outline-primary">View</a>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="10" class="text-center py-4">
              <p class="text-muted mb-0">No patients found.</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
{% if is_paginated %}
<nav aria-label="Page navigation" class="mt-3">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}">First</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}">Previous</a>
      </li>
    {% endif %}
    
    <li class="page-item active">
      <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
    </li>
    
    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}">Next</a>
      </li>
      <li class="page-item">
        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.sex %}&sex={{ request.GET.sex }}{% endif %}">Last</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}

