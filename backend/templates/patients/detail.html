{% extends "base.html" %}
{% load static %}

{% block title %}{{ patient.patient_id }} | PTLD System{% endblock %}

{% block breadcrumbs %}
<a href="{% url 'patients:patient-list' %}">Home</a>
&rsaquo; <a href="{% url 'patients:patient-list' %}">Patients</a>
&rsaquo; {{ patient.patient_id }}
{% endblock %}

{% block content %}
<h1>Patient: {{ patient.patient_id }}</h1>

<ul class="object-tools">
    <li>
        <a href="{% url 'patients:patient-edit' patient.patient_id %}" class="changelink">Change</a>
    </li>
    <li>
        <a href="{% url 'patients:patient-list' %}">← Back to list</a>
    </li>
</ul>

<div class="module">
    <h2>Patient Information</h2>
    <table>
        <tr>
            <th>Patient ID:</th>
            <td>{{ patient.patient_id }}</td>
        </tr>
        <tr>
            <th>Sex:</th>
            <td>{{ patient.sex }}</td>
        </tr>
        <tr>
            <th>Age:</th>
            <td>{{ patient.age }} years</td>
        </tr>
        <tr>
            <th>BMI:</th>
            <td>{% if patient.bmi %}{{ patient.bmi|floatformat:1 }}{% else %}<span class="quiet">-</span>{% endif %}</td>
        </tr>
        <tr>
            <th>HIV Positive:</th>
            <td>
                {% if patient.hiv_positive %}
                    <img src="{% static 'admin/img/icon-yes.svg' %}" alt="True">
                {% else %}
                    <img src="{% static 'admin/img/icon-no.svg' %}" alt="False">
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Diabetes:</th>
            <td>
                {% if patient.diabetes %}
                    <img src="{% static 'admin/img/icon-yes.svg' %}" alt="True">
                {% else %}
                    <img src="{% static 'admin/img/icon-no.svg' %}" alt="False">
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Smoker:</th>
            <td>
                {% if patient.smoker %}
                    <img src="{% static 'admin/img/icon-yes.svg' %}" alt="True">
                {% else %}
                    <img src="{% static 'admin/img/icon-no.svg' %}" alt="False">
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>X-Ray Score:</th>
            <td>{% if patient.x_ray_score %}{{ patient.x_ray_score|floatformat:1 }}{% else %}<span class="quiet">-</span>{% endif %}</td>
        </tr>
        <tr>
            <th>District:</th>
            <td>{{ patient.district|default:"-" }}</td>
        </tr>
        <tr>
            <th>Comorbidities:</th>
            <td>{{ patient.comorbidities|default:"-" }}</td>
        </tr>
        <tr>
            <th>Baseline Date:</th>
            <td>{% if patient.baseline_date %}{{ patient.baseline_date }}{% else %}<span class="quiet">-</span>{% endif %}</td>
        </tr>
    </table>
</div>

<div class="module">
    <h2>Treatment Regimens</h2>
    <table>
        <thead>
            <tr>
                <th>Regimen ID</th>
                <th>Drugs</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Outcome</th>
            </tr>
        </thead>
        <tbody>
            {% for r in regimens %}
            <tr>
                <td>{{ r.regimen_id }}</td>
                <td>{{ r.drugs }}</td>
                <td>{% if r.start_date %}{{ r.start_date }}{% else %}<span class="quiet">-</span>{% endif %}</td>
                <td>{% if r.end_date %}{{ r.end_date }}{% else %}<span class="quiet">-</span>{% endif %}</td>
                <td>{{ r.outcome|default:"-" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center"><span class="quiet">No regimens</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="module">
    <h2>Treatment Modifications</h2>
    <table>
        <thead>
            <tr>
                <th>Modification ID</th>
                <th>Modified Drug</th>
                <th>Reason</th>
                <th>Date</th>
                <th>New Dosage (mg)</th>
            </tr>
        </thead>
        <tbody>
            {% for m in modifications %}
            <tr>
                <td>{{ m.modification_id }}</td>
                <td>{{ m.modified_drug }}</td>
                <td>{{ m.reason }}</td>
                <td>{% if m.date %}{{ m.date }}{% else %}<span class="quiet">-</span>{% endif %}</td>
                <td>{% if m.new_dosage_mg %}{{ m.new_dosage_mg }}{% else %}<span class="quiet">-</span>{% endif %}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="5" class="text-center"><span class="quiet">No modifications</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="module">
    <h2>Monitoring Visits</h2>
    <table>
        <thead>
            <tr>
                <th>Visit ID</th>
                <th>Date</th>
                <th>Adherence %</th>
                <th>Smear Result</th>
                <th>Adverse Reactions</th>
                <th>Weight (kg)</th>
            </tr>
        </thead>
        <tbody>
            {% for v in visits %}
            <tr>
                <td>{{ v.visit_id }}</td>
                <td>{% if v.date %}{{ v.date }}{% else %}<span class="quiet">-</span>{% endif %}</td>
                <td>{% if v.adherence_pct %}{{ v.adherence_pct|floatformat:1 }}%{% else %}<span class="quiet">-</span>{% endif %}</td>
                <td>{{ v.smear_result|default:"-" }}</td>
                <td>{{ v.adverse_reactions|default:"-" }}</td>
                <td>{% if v.weight_kg %}{{ v.weight_kg|floatformat:1 }}{% else %}<span class="quiet">-</span>{% endif %}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center"><span class="quiet">No visits</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="module">
    <h2>Risk Predictions & Explainability</h2>
    <div style="padding: 15px;">
        <button id="generatePredictionBtn" class="button default" onclick="generatePrediction('{{ patient.patient_id }}')">
            <span id="predictionBtnText">Generate New Prediction</span>
            <span id="predictionBtnSpinner" style="display: none;">...</span>
        </button>
        
        {% if predictions %}
        <div style="margin-top: 20px;">
            {% for p in predictions %}
            <div style="border: 1px solid #ddd; margin-bottom: 15px; border-radius: 4px;">
                <h3 style="background: #f5f5f5; padding: 10px; margin: 0; border-bottom: 1px solid #ddd; font-size: 14px;">
                    {{ p.prediction_id }} - 
                    <span style="padding: 2px 8px; border-radius: 3px; font-size: 12px; 
                        {% if p.risk_category == 'low' %}background: #28a745; color: #fff;
                        {% elif p.risk_category == 'medium' %}background: #ffc107; color: #000;
                        {% else %}background: #dc3545; color: #fff;{% endif %}">
                        {{ p.risk_category|upper }}
                    </span>
                    <span style="color: #666; font-weight: normal;">Risk Score: {{ p.risk_score|floatformat:3 }}</span>
                    <span style="float: right; color: #666; font-size: 12px; font-weight: normal;">{{ p.timestamp|date:"Y-m-d H:i" }}</span>
                </h3>
                <div style="padding: 15px;">
                    <p><strong>Model Version:</strong> {{ p.model_version }}</p>
                    <p><strong>Confidence:</strong> {{ p.confidence|floatformat:2 }}</p>
                    
                    {% if p.recommendations %}
                    <div style="margin-top: 15px;">
                        <h4 style="font-size: 13px; margin-bottom: 10px;">Clinical Recommendations</h4>
                        {% for rec in p.recommendations %}
                        <div style="border-left: 3px solid {% if rec.priority == 'high' %}#dc3545{% elif rec.priority == 'medium' %}#ffc107{% else %}#17a2b8{% endif %}; padding-left: 10px; margin-bottom: 10px;">
                            <strong>{{ rec.title }}</strong> <span style="font-size: 11px; color: #666;">({{ rec.priority|upper }})</span>
                            <p style="margin: 5px 0; color: #666; font-size: 12px;">{{ rec.description }}</p>
                            {% if rec.actions %}
                            <ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">
                                {% for action in rec.actions %}
                                <li>{{ action }}</li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if p.shap_values %}
                    <div style="margin-top: 15px;">
                        <h4 style="font-size: 13px; margin-bottom: 10px;">Feature Importance (SHAP Values)</h4>
                        <table style="width: 100%; font-size: 12px;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 8px;">Feature</th>
                                    <th style="padding: 8px;">SHAP Value</th>
                                    <th style="padding: 8px;">Impact</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if p.shap_values_sorted %}
                                    {% for feature, value in p.shap_values_sorted|slice:":10" %}
                                    <tr>
                                        <td style="padding: 8px;"><code>{{ feature }}</code></td>
                                        <td style="padding: 8px; {% if value > 0 %}color: #dc3545;{% elif value < 0 %}color: #28a745;{% endif %} font-weight: bold;">
                                            {{ value|floatformat:4 }}
                                        </td>
                                        <td style="padding: 8px;">
                                            {% if value > 0 %}
                                                <span style="background: #dc3545; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 11px;">↑ Increases Risk</span>
                                            {% elif value < 0 %}
                                                <span style="background: #28a745; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 11px;">↓ Decreases Risk</span>
                                            {% else %}
                                                <span style="background: #6c757d; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 11px;">Neutral</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    
                    {% if p.waterfall_plot or p.force_plot %}
                    <div style="margin-top: 15px;">
                        <h4 style="font-size: 13px; margin-bottom: 10px;">SHAP Visualizations</h4>
                        {% if p.waterfall_plot %}
                        <div style="margin-bottom: 15px;">
                            <img src="/{{ p.waterfall_plot }}" alt="SHAP Waterfall Plot" style="max-width: 100%; height: auto; border: 1px solid #ddd;">
                        </div>
                        {% endif %}
                        {% if p.force_plot %}
                        <div>
                            <img src="/{{ p.force_plot }}" alt="SHAP Force Plot" style="max-width: 100%; height: auto; border: 1px solid #ddd;">
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="padding: 15px; text-align: center; color: #666;">
            <p>No predictions yet. Click "Generate New Prediction" to create a risk assessment for this patient.</p>
        </div>
        {% endif %}
        
        <div id="predictionAlert" style="display: none; margin-top: 15px; padding: 10px; border-radius: 4px;"></div>
    </div>
</div>

<script>
function generatePrediction(patientId) {
    const btn = document.getElementById('generatePredictionBtn');
    const btnText = document.getElementById('predictionBtnText');
    const btnSpinner = document.getElementById('predictionBtnSpinner');
    const alertDiv = document.getElementById('predictionAlert');
    
    btn.disabled = true;
    btnText.textContent = 'Generating...';
    btnSpinner.style.display = 'inline';
    alertDiv.style.display = 'none';
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
    
    fetch('/api/predictions/predict/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ patient_id: patientId }),
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => Promise.reject(err));
        }
        return response.json();
    })
    .then(data => {
        alertDiv.style.cssText = 'display: block; margin-top: 15px; padding: 10px; border-radius: 4px; background: #d4edda; color: #155724; border: 1px solid #c3e6cb;';
        alertDiv.innerHTML = '<strong>Success!</strong> Prediction generated. Reloading page...';
        setTimeout(() => window.location.reload(), 1500);
    })
    .catch(error => {
        btn.disabled = false;
        btnText.textContent = 'Generate New Prediction';
        btnSpinner.style.display = 'none';
        alertDiv.style.cssText = 'display: block; margin-top: 15px; padding: 10px; border-radius: 4px; background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;';
        alertDiv.innerHTML = '<strong>Error:</strong> ' + (error.detail || error.message || 'Failed to generate prediction');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
